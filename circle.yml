machine:
  environment:
    release: 0.0.${CIRCLE_BUILD_NUM}
    MAVEN_OPTS: "-Xmx1g -DbuildNumber=${CIRCLE_BUILD_NUM} "

  java:
    version: oraclejdk8

deployment:
  staging:
      branch: staging
      commands:
        - git config --global user.email "hello@neilellis.me"
        - git config --global user.name "Neil Ellis"
        - git reset HEAD --hard
        - git clean -fd
        - git checkout master
        - git pull
        - git merge staging -m "Auto merge"
        - git push
        - echo ${release} > .release
        - envsubst < README.md > README.expanded
        - mv README.expanded README.md
        - 'git commit -a -m "Promotion from staging" || :'
        - "git tag ${release} || :"
        - git push --tags
        - git push origin master

  production:
      branch: master
      commands:
        - git config --global user.email "hello@neilellis.me"
        - git config --global user.name "Neil Ellis"
        - mvn versions:set -DnewVersion=$(cat .release)
        - mvn versions:resolve-ranges
        - mvn versions:lock-snapshots
#        - mvn versions:commit
        - mvn -T 1C -Dmaven.test.skip=true -Drat.skip=true -DskipEnforcer -Dmaven.javadoc.skip=true -DgenerateReports=false package
        - mvn -T 2C -Dmaven.test.skip=true -Drat.skip=true -DskipEnforcer -Dmaven.javadoc.skip=true -DgenerateReports=false deploy
